
R version 4.3.3 (2024-02-29) -- "Angel Food Cake"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> require("tools")
Loading required package: tools
> 
> # -------------------------------------------------------------------
> # prepare_Rd() is OK with a top level \Sexpr that is yet to be rendered
> 
> txt <- "
+ \\name{foo}
+ \\title{Title}
+ \\description{Desc.}
+ \\Sexpr[stage=render,results=rd]{\"\\\\\\details{This is dynamic.}\"}
+ "
> 
> rd <- parse_Rd(con <- textConnection(txt)); close(con)
> 
> warn <- NULL
> withCallingHandlers(
+   rd2 <- tools:::prepare_Rd(rd),
+   warning = function(w) { warn <<- w; invokeRestart("muffleWarning") }
+ )
> stopifnot(is.null(warn))
> stopifnot("\\Sexpr" %in% tools:::RdTags(rd2))
> 
> 
> ## \Sexpr[stage=build, results=hide]{ <a dozen "empty" lines> }
> tf <- textConnection("RdTeX", "w")
> Rd2latex("Rd-Sexpr-hide-empty.Rd", tf, stages="build")
> tex <- textConnectionValue(tf); close(tf); rm(tf)
> (H2end <- tex[grep("^Hello", tex):length(tex)])
[1] "Hello"          ""               "\\end{Details}"
> stopifnot((n <- length(H2end)) <= 4, # currently '3'; was 13 in R < 4.2.0
+           H2end[-c(1L,n)] == "")     # also had \\AsIs{ .. }  " "  "   "
> 
> 
> ## checkRd() gives file name and correct line number of \Sexpr[results=rd] chunk
> stopifnot(grepl("Rd-Sexpr-warning.Rd:5:",
+                 print(checkRd("Rd-Sexpr-warning.Rd", stages = "build")),
+                 fixed = TRUE))
checkRd: (7) Rd-Sexpr-warning.Rd:5: Tag \strong is invalid in a \code block
> 
> ## processRdChunk() gives file name and location of eval error
> (msg <- tryCatch(checkRd(file_path_as_absolute("Rd-Sexpr-error.Rd")),
+                  error = conditionMessage))
[1] "Rd-Sexpr-error.Rd:4-7: non-numeric argument to binary operator"
> stopifnot(startsWith(msg, "Rd-Sexpr-error.Rd:4-7:"),
+           length(checkRd("Rd-Sexpr-error.Rd", stages = NULL)) == 0)
> ## file name and line numbers were missing in R < 4.2.0
> 
> 
> ## \doi with hash symbol or Rd specials
> rd <- parse_Rd("doi.Rd")
> writeLines(out <- capture.output(Rd2txt(rd, stages = "build")))
_T_e_s_t \_d_o_i _w_i_t_h _h_a_s_h _o_r _R_d _s_p_e_c_i_a_l_s

_D_e_s_c_r_i_p_t_i_o_n:

     doi:10.1000/456#789 <https://doi.org/10.1000/456%23789>

     doi:10.1000/{} <https://doi.org/10.1000/%7B%7D>

> stopifnot(grepl("10.1000/456#789", out[5], fixed = TRUE),
+           grepl("doi.org/10.1000/456%23789", out[5], fixed = TRUE),
+           grepl("10.1000/{}", out[7], fixed = TRUE),
+           grepl("doi.org/10.1000/%7B%7D", out[7], fixed = TRUE))
> ## R < 4.2.0 failed to encode the hash and lost {}
> 
